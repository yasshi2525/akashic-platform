services:
  valkey-1:
    image: valkey/valkey:8
    command: >
      valkey-server
      --port 7001
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --cluster-announce-hostname valkey-1
      --cluster-announce-port 7001
      --cluster-announce-bus-port 17001
    ports:
      - "7001:7001"
    healthcheck:
      test: ["CMD", "valkey-cli", "-p", "7001", "PING"]
      interval: 2s
      timeout: 2s
      retries: 10
    networks:
      apnet:
        ipv4_address: 172.30.0.11

  valkey-2:
    image: valkey/valkey:8
    command: >
      valkey-server
      --port 7002
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --cluster-announce-hostname valkey-2
      --cluster-announce-port 7002
      --cluster-announce-bus-port 17002
    ports:
      - "7002:7002"
    healthcheck:
      test: ["CMD", "valkey-cli", "-p", "7002", "PING"]
      interval: 2s
      timeout: 2s
      retries: 10
    networks:
      apnet:
        ipv4_address: 172.30.0.12

  valkey-3:
    image: valkey/valkey:8
    command: >
      valkey-server
      --port 7003
      --cluster-enabled yes
      --cluster-config-file nodes.conf
      --cluster-node-timeout 5000
      --appendonly yes
      --cluster-announce-hostname valkey-3
      --cluster-announce-port 7003
      --cluster-announce-bus-port 17003
    ports:
      - "7003:7003"
    healthcheck:
      test: ["CMD", "valkey-cli", "-p", "7003", "PING"]
      interval: 2s
      timeout: 2s
      retries: 10
    networks:
      apnet:
        ipv4_address: 172.30.0.13

  valkey-setup:
    image: valkey/valkey:8
    depends_on:
      valkey-1:
        condition: service_healthy
      valkey-2:
        condition: service_healthy
      valkey-3:
        condition: service_healthy
    command: |
      /bin/sh -c '
        set +e
        valkey-cli --cluster check valkey-1:7001 | grep "[ERR]"
        if [ $? -eq 0 ]; then
          valkey-cli --cluster create valkey-1:7001 valkey-2:7002 valkey-3:7003 --cluster-replicas 0 --cluster-yes
        fi
        set -e
      '
    restart: no
    networks:
      - apnet

  postgres:
    image: postgres
    ports:
      - 5432:5432
    environment:
      POSTGRES_DB: akashic
      POSTGRES_USER: ap-user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ap-user -d akashic"]
      interval: 5s
      timeout: 4s
      retries: 10
    networks:
      - apnet

  minio:
    image: minio/minio
    ports:
      - 9000:9000
      - 9001:9001
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 4s
      retries: 10
    networks:
      - apnet

  minio-setup:
    image: minio/mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c
      "mc alias set local http://minio:9000 minioadmin minioadmin
      && mc mb -p local/akashic-content || true
      && mc anonymous set public local/akashic-content"
    networks:
      - apnet

  db-migrate:
    build:
      context: .
      dockerfile: schema/persist/Dockerfile
    user: 1000:1000
    environment:
      DATABASE_URL: postgres://ap-user:${POSTGRES_PASSWORD:-postgres}@postgres:5432/akashic
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - apnet

  akashic-storage:
    build:
      context: .
      dockerfile: akashic-storage/Dockerfile
    ports:
      - 3031:3031
      - 3033:3033
    user: 1000:1000
    environment:
      PUBLIC_PORT: 3031
      ADMIN_PORT: 3033
      CLIENT_ORIGIN: http://localhost:3000
      VALKEY_HOST: valkey-1
      VALKEY_PORT: 7001
      VALKEY_NO_TLS: true
      STORAGE_ADMIN_TOKEN: ${STORAGE_ADMIN_TOKEN:-local-storage-admin-token}
      INFLIGHT_REQUEST_LIMIT: 1000
    depends_on:
      valkey-setup:
        condition: service_completed_successfully
    networks:
      - apnet

  akashic-server:
    build:
      context: .
      dockerfile: akashic-server/Dockerfile
    ports:
      - 3032:3032
    user: 1000:1000
    environment:
      PORT: 3032
      STORAGE_PUBLIC_URL: http://akashic-storage:3031
      STORAGE_ADMIN_URL: http://akashic-storage:3033
      STORAGE_ADMIN_TOKEN: ${STORAGE_ADMIN_TOKEN:-local-storage-admin-token}
      SERVER_API_TOKEN: ${SERVER_API_TOKEN:-local-server-api-token}
      DATABASE_URL: postgres://ap-user:${POSTGRES_PASSWORD:-postgres}@postgres:5432/akashic
    depends_on:
      db-migrate:
        condition: service_completed_successfully
    networks:
      - apnet

  webapp:
    build:
      context: .
      dockerfile: webapp/Dockerfile
    ports:
      - 3000:3000
    user: 1000:1000
    environment:
      PORT: 3000
      PUBLIC_BASE_URL: http://localhost:3000
      INTERNAL_BASE_URL: http://webapp:3000
      PUBLIC_CONTENT_BASE_URL: http://localhost:9000/akashic-content
      INTERNAL_CONTENT_BASE_URL: http://minio:9000/akashic-content
      PUBLIC_STORAGE_URL: http://localhost:3031
      INTERNAL_STORAGE_URL: http://akashic-storage:3031
      SERVER_URL: http://akashic-server:3032
      SERVER_API_TOKEN: ${SERVER_API_TOKEN:-local-server-api-token}
      DATABASE_URL: postgres://ap-user:${POSTGRES_PASSWORD:-postgres}@postgres:5432/akashic
      NEXTAUTH_URL: http://localhost:3000
      AUTH_TRUST_HOST: true
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: akashic-content
      S3_REGION: us-east-1
      S3_FORCE_PATH_STYLE: true
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
    env_file:
      - .env
    depends_on:
      db-migrate:
        condition: service_completed_successfully
    networks:
      - apnet

networks:
  apnet:
    driver: bridge
    ipam:
     driver: default
     config:
       - subnet: 172.30.0.0/24
